From 8216e64ddd287ef7f40e1a224473f79de44645ff Mon Sep 17 00:00:00 2001
From: William Douglas <william.douglas@intel.com>
Date: Mon, 2 Apr 2018 21:57:23 +0000
Subject: [PATCH] cve-2018-5709

---
 src/kadmin/dbutil/dump.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/kadmin/dbutil/dump.c b/src/kadmin/dbutil/dump.c
index aca136f0b..bc8448593 100644
--- a/src/kadmin/dbutil/dump.c
+++ b/src/kadmin/dbutil/dump.c
@@ -715,6 +715,7 @@ process_k5beta7_princ(krb5_context context, const char *fname, FILE *filep,
     krb5_db_entry *dbentry;
     int t1, t2, t3, t4;
     unsigned int u1, u2, u3, u4, u5;
+    krb5_int16 u_key_data;
     char *name = NULL;
     krb5_key_data *kp = NULL, *kd;
     krb5_tl_data *tl;
@@ -733,6 +734,12 @@ process_k5beta7_princ(krb5_context context, const char *fname, FILE *filep,
         load_err(fname, *linenop, _("cannot match size tokens"));
         goto fail;
     }
+    // Validate u4 isn't greater than the max value of a 16bit signed int
+    if (u4 > 32767) {
+        load_err(fname, *linenop, _("key data length out of bounds"));
+        goto fail;
+    }
+    u_key_data = (krb5_int16)u4;
 
     /* Get memory for flattened principal name */
     name = malloc(u2 + 1);
-- 
2.16.3

